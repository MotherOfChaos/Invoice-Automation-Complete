# üöÄ INVOICE AUTOMATION v1.5 - DEPLOYMENT GUIDE

## üìå VERSION INFO
- **Version:** v1.5
- **Date:** 2025-01-19
- **For:** Teatro Metamorfosis
- **Critical Fix:** ICON FILTERING + Size threshold (50KB minimum)

---

## üÜï WHAT'S NEW IN v1.5?

### üêõ **CRITICAL BUG FIX: Icon Filtering Restored**

**The Problem in v1.4:**
- Extracted ALL attachments from emails with keywords in subject
- This included icons, logos, signatures, tracking pixels
- Result: Hundreds of unwanted small image files

**The Fix in v1.5:**
‚úÖ Added **50KB minimum file size** threshold
‚úÖ Filters out **GIF, ICO, HTML, plain text** files
‚úÖ Skips **email signature images**
‚úÖ Skips **tracking pixels**
‚úÖ Saves ONLY actual invoice documents

### üéØ **COMPLETE WORKFLOW (v1.5):**

```
1. Gmail Search
   ‚Üì
   subject:(invoice OR factura OR...) + has:attachment
   ‚Üì
2. For each email with matching subject:
   ‚Üì
3. For each attachment:
   ‚Üì
   - Check file size (must be ‚â• 50KB)
   - Check content type (skip GIF/ICO/HTML/text)
   ‚Üì
4. Save qualifying attachments to Drive
   ‚Üì
5. Extract data with Vision API
```

### üìä **FILTERING CRITERIA:**

| Filter Type | Rule | Purpose |
|------------|------|---------|
| **Email Subject** | Must contain keyword | Gets relevant emails |
| **File Size** | Must be ‚â• 50KB | Skips icons/logos |
| **Content Type** | Skip GIF/ICO/HTML/text | Skips non-documents |
| **Duplicates** | Check existing files | Prevents re-processing |

---

## üîç **WHAT GETS SAVED vs SKIPPED**

### ‚úÖ **SAVED (Invoices):**
- PDF files (any size > 50KB)
- PNG invoice scans (> 50KB)
- JPG invoice photos (> 50KB)
- Large image files (> 50KB)

### ‚ùå **SKIPPED (Non-Invoices):**
- Small icons (< 50KB)
- Email signatures (< 50KB)
- Logos (< 50KB)
- GIF animations
- ICO files
- HTML attachments
- Plain text attachments
- Tracking pixels (typically 1-2KB)

---

## üìç FILE LOCATIONS

### Main Script File:
```
C:\Users\sarah\Desktop\CLAUDE DATABASE DOCS\PROJECTS\INVOICE EXTRACT AUTOMATION\phase1-automation\INVOICE_AUTOMATION_FINAL.gs
```

### Version Backup:
```
C:\Users\sarah\Desktop\CLAUDE DATABASE DOCS\PROJECTS\INVOICE EXTRACT AUTOMATION\phase1-automation\versions\v1.5_icon_filtering_fix.gs
```

---

## üîß DEPLOYMENT STEPS

### Step 1: Access Google Apps Script
1. Go to https://script.google.com
2. Open your existing Teatro invoice automation project

### Step 2: Replace Code
1. Select ALL existing code (Ctrl+A)
2. Delete it
3. Copy ALL code from `INVOICE_AUTOMATION_FINAL.gs`
4. Paste into Google Apps Script editor
5. Click "Save" (disk icon)

### Step 3: Run Initial Setup
1. Select function: `firstRun`
2. Click "Run" (play button)
3. Authorize when prompted
4. Watch the execution log (View ‚Üí Execution log)
5. Wait for completion (5-15 minutes)

### Step 4: Check Results
Look for this in the execution log:
```
üìß Emails scanned: XXX
üìé Invoices found: XXX
üìÅ Files organized: XXX
‚äò Skipped small files: XXX  ‚Üê NEW!
üìä Data rows extracted: XXX
```

You should see messages like:
```
‚äò Skipped small file (15KB): logo.png
‚äò Skipped small file (3KB): signature.gif
‚äò Skipped non-document type (image/gif): tracking.gif
‚úì Organized: 2025-01-15_Invoice_Jan.pdf (245KB) ‚Üí 2025/1r trimestre
```

---

## üìã KEYWORDS (24 TOTAL - Unchanged)

**Original Keywords (10):**
- invoice, invoices
- factura, facturas
- pago, pagos
- recibo, receipt
- payment, payout

**Invoice Abbreviations (4):**
- fra, ftra, fac, fact

**Payroll Terms (6):**
- n√≥mina, nomina, n√∂mina, nom
- hoja de pago, hojas de pago

**Additional Terms (3):**
- justificante de presentaci√≥n
- limitador de sonido caducado
- credit note

---

## üìä VERSION COMPARISON

| Version | Icon Filtering | File Size Check | Search Method | Status |
|---------|---------------|----------------|---------------|--------|
| v1.0 | ‚ùå No | ‚ùå No | Filename only | Bug: extracted icons |
| v1.1 | ‚ö†Ô∏è Filename only | ‚ùå No | Filename only | Still got icons |
| v1.2 | ‚ö†Ô∏è Filename only | ‚ùå No | Filename only | Still got icons |
| v1.3 | ‚ö†Ô∏è Subject OR filename | ‚ùå No | Subject + Filename | Still got icons |
| v1.4 | ‚ùå **REMOVED** | ‚ùå No | Subject only | **BUG: Extracted ALL** |
| **v1.5** | ‚úÖ **Size + Type** | ‚úÖ **50KB min** | **Subject only** | **FIXED!** ‚úÖ |

---

## üîß TROUBLESHOOTING

### "Still getting small icon files"
- Check execution log for "Skipped small file" messages
- Verify file sizes in Drive (should all be > 50KB)
- If needed, increase threshold in CONFIG (currently 50KB)

### "Missing legitimate invoices"
- Check if invoices are smaller than 50KB
- Review execution log for skipped files
- Adjust threshold if needed (lower to 30KB or 40KB)

### "Getting HTML or text attachments"
- These should be filtered out automatically
- Check execution log for "Skipped non-document type"
- Report if still appearing

---

## üéØ KEY IMPROVEMENTS IN v1.5

### 1. **Size-Based Filtering**
```javascript
if (fileSize < 50000) { // 50KB = 50,000 bytes
  Logger.log(`Skipped small file: ${fileName}`);
  return;
}
```

### 2. **Content-Type Filtering**
```javascript
const skipTypes = [
  'image/gif',
  'image/x-icon',
  'image/vnd.microsoft.icon',
  'text/html',
  'text/plain'
];
```

### 3. **Better Logging**
Now shows file size in KB:
```
‚úì Organized: invoice.pdf (245KB) ‚Üí 2025/1r trimestre
```

---

## üí∞ SYSTEM COSTS (Unchanged)

### ‚úÖ **FREE COMPONENTS:**
- Google Apps Script, Gmail API, Drive API, Sheets API

### üíµ **PAID COMPONENT:**
- **Google Cloud Vision API:** $0-3/month for most businesses
- First 1,000 requests/month: FREE

---

## ‚úÖ CONCLUSION

**v1.5 fixes the critical icon extraction bug from v1.4.**

**Deploy this version immediately** if you experienced icon extraction issues with v1.4.

**This is the STABLE, PRODUCTION-READY version.**

---

*Last updated: 2025-01-19*
*Use this version for Teatro deployment*
