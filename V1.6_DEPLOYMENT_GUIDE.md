# üöÄ INVOICE AUTOMATION v1.6 - DEPLOYMENT GUIDE

## üìå VERSION INFO
- **Version:** v1.6
- **Date:** 2025-01-19
- **For:** Teatro Metamorfosis
- **Major Fix:** SMART FILTERING - Filename keyword checking + skip-words + control folder

---

## üÜï WHAT'S NEW IN v1.6?

### üêõ **CRITICAL BUG FIX: Small Invoices Were Being Skipped**

**The Problem in v1.5:**
- Used 50KB size threshold for ALL files
- Skipped legitimate small invoices like:
  - ‚ùå `N√∂mina 08_2025.pdf` (19KB) - PAYROLL DOCUMENT!
  - ‚ùå `LAS TIAS DEL SEC FACTURA 06 11.pdf` (49KB) - INVOICE!
  - ‚ùå `NOMINA LAURA DESEMBRE.pdf` (17KB) - PAYROLL DOCUMENT!

These files had invoice keywords in the FILENAME but were rejected due to size!

**The Fix in v1.6:**
‚úÖ **Filename keyword checking** - If filename contains invoice keywords, SAVE IT (ignore size)
‚úÖ **Skip-words list** - If filename contains "icon", "logo", "header", etc., SKIP IT
‚úÖ **Control folder** - All skipped files saved to `CONTROL_SKIPPED_FILES` for analysis
‚úÖ **Smarter logic** - Multi-step filtering process

---

## üéØ **NEW FILTERING LOGIC (v1.6)**

### **4-Step Smart Filter:**

```
STEP 1: Does filename contain invoice keywords?
        (factura, n√≥mina, invoice, pago, etc.)
        ‚Üí YES: SAVE IT ‚úì (bypass size check)
        ‚Üí NO: Go to Step 2

STEP 2: Does filename contain skip-words?
        (header, icon, badge, logo, signature, etc.)
        ‚Üí YES: SKIP IT ‚úó
        ‚Üí NO: Go to Step 3

STEP 3: Is file size >= 50KB?
        ‚Üí NO: SKIP IT ‚úó (likely icon/logo)
        ‚Üí YES: Go to Step 4

STEP 4: Is content type acceptable?
        (not GIF, ICO, HTML, plain text)
        ‚Üí NO: SKIP IT ‚úó
        ‚Üí YES: SAVE IT ‚úì
```

---

## üìã **NEW CONFIGURATION OPTIONS**

### **Skip-Words (Auto-configured):**
```javascript
skipWords: [
  'header',
  'icon',
  'badge',
  'logo',
  'signature',
  'footer',
  'banner',
  'tracking',
  'pixel',
  'spacer',
  'button'
],
```

**These words in filenames = automatic skip**

### **Control Folder (New Feature):**
```javascript
enableControlFolder: true,  // Set to false to disable
controlFolderName: 'CONTROL_SKIPPED_FILES',
```

**What it does:**
- Creates a `CONTROL_SKIPPED_FILES` folder in Drive
- Saves ALL skipped files with `[SKIPPED]` prefix
- Allows you to review what was rejected
- Filename format: `2025-01-15_[SKIPPED]_original_filename.ext`

---

## üìä **EXAMPLES - WHAT GETS SAVED vs SKIPPED**

### ‚úÖ **NOW SAVED (v1.6):**

| Filename | Size | Reason |
|----------|------|--------|
| `N√∂mina 08_2025.pdf` | 19KB | ‚úì Has keyword "n√∂mina" |
| `LAS TIAS DEL SEC FACTURA 06 11.pdf` | 49KB | ‚úì Has keyword "factura" |
| `NOMINA LAURA DESEMBRE.pdf` | 17KB | ‚úì Has keyword "nomina" |
| `fra_012345.pdf` | 15KB | ‚úì Has keyword "fra" |
| `recibo-enero.jpg` | 35KB | ‚úì Has keyword "recibo" |

### ‚ùå **STILL SKIPPED (v1.6):**

| Filename | Size | Reason |
|----------|------|--------|
| `company_logo.png` | 25KB | ‚úó Has skip-word "logo" |
| `email_signature.jpg` | 18KB | ‚úó Has skip-word "signature" |
| `header_image.png` | 42KB | ‚úó Has skip-word "header" |
| `icon_calendar.gif` | 3KB | ‚úó Has skip-word "icon" + GIF type |
| `random_file.png` | 12KB | ‚úó Small + no keywords |

---

## üîç **CONTROL FOLDER - HOW IT WORKS**

### **Location:**
```
Google Drive (root) ‚Üí CONTROL_SKIPPED_FILES/
```

### **File Naming:**
```
2025-01-15_[SKIPPED]_logo.png
2025-01-15_[SKIPPED]_signature.jpg
2025-01-15_[SKIPPED]_random.pdf
```

### **Purpose:**
1. Review all files that were skipped
2. Identify false positives (legitimate invoices incorrectly rejected)
3. Refine skip-words list based on actual data
4. Adjust filtering criteria as needed

### **How to Use:**
1. Run the script with v1.6
2. Check the `CONTROL_SKIPPED_FILES` folder
3. Review files with `[SKIPPED]` prefix
4. If you find legitimate invoices:
   - Add more invoice keywords, OR
   - Remove problematic skip-words, OR
   - Lower the 50KB threshold

### **Disable Control Folder:**
If you don't want skipped files saved:
```javascript
enableControlFolder: false,  // In CONFIG
```

---

## üìç FILE LOCATIONS

### Main Script File:
```
C:\Users\sarah\Desktop\CLAUDE DATABASE DOCS\PROJECTS\INVOICE EXTRACT AUTOMATION\phase1-automation\INVOICE_AUTOMATION_FINAL.gs
```

### Version Backup:
```
C:\Users\sarah\Desktop\CLAUDE DATABASE DOCS\PROJECTS\INVOICE EXTRACT AUTOMATION\phase1-automation\versions\v1.6_smart_filtering_control_folder.gs
```

---

## üîß DEPLOYMENT STEPS

### Step 1: Access Google Apps Script
1. Go to https://script.google.com
2. Open your existing Teatro invoice automation project

### Step 2: Replace Code
1. Select ALL existing code (Ctrl+A)
2. Delete it
3. Copy ALL code from `INVOICE_AUTOMATION_FINAL.gs`
4. Paste into Google Apps Script editor
5. Click "Save" (disk icon)

### Step 3: Run Initial Setup
1. Select function: `firstRun`
2. Click "Run" (play button)
3. Authorize when prompted
4. Watch the execution log (View ‚Üí Execution log)
5. Wait for completion (5-15 minutes)

### Step 4: Check Results
Look for this in the execution log:
```
üìß Emails scanned: XXX
üìé Invoices found: XXX
‚úì Filename has keyword, saving regardless of size: N√∂mina 08_2025.pdf (19KB)
‚úì Filename has keyword, saving regardless of size: LAS TIAS DEL SEC FACTURA 06 11.pdf (49KB)
‚äò Skipped (skip-word in filename): company_logo.png
‚äò Skipped (small size 12KB): random_image.jpg
üíæ Saved to control folder: 2025-01-15_[SKIPPED]_logo.png
üìÅ Files organized: XXX
üìä Data rows extracted: XXX
```

### Step 5: Review Control Folder
1. Open Google Drive
2. Find `CONTROL_SKIPPED_FILES` folder
3. Review files with `[SKIPPED]` prefix
4. Verify legitimate invoices are NOT in this folder
5. Identify any patterns in skipped files

---

## üìã KEYWORDS (24 TOTAL - Unchanged from v1.5)

**Used for:**
1. Email subject search (Gmail API level)
2. **NEW:** Filename checking (v1.6)

**Keywords:**
- Original: invoice, invoices, factura, facturas, pago, pagos, recibo, receipt, payment, payout
- Abbreviations: fra, ftra, fac, fact
- Payroll: n√≥mina, nomina, n√∂mina, nom, hoja de pago, hojas de pago
- Additional: justificante de presentaci√≥n, limitador de sonido caducado, credit note

---

## üìä VERSION COMPARISON

| Version | Filtering Logic | Small Invoices | Control Folder | Status |
|---------|----------------|----------------|----------------|--------|
| v1.5 | Size only (50KB) | ‚ùå Skipped | ‚ùå No | Bug |
| **v1.6** | **Filename keywords + skip-words + size** | **‚úÖ Saved** | **‚úÖ Yes** | **FIXED** ‚úÖ |

---

## üîß CUSTOMIZATION

### **Add More Skip-Words:**
If you find other patterns in the control folder:
```javascript
skipWords: [
  'header',
  'icon',
  // ... existing words
  'your_new_word',  // Add here
],
```

### **Adjust Size Threshold:**
If 50KB is too high/low:
```javascript
else if (fileSize < 30000) { // Changed to 30KB
  skipReason = `small size (${Math.round(fileSize/1024)}KB)`;
}
```

### **Disable Control Folder:**
Once you're confident filtering is working:
```javascript
enableControlFolder: false,  // Stops saving skipped files
```

---

## üîß TROUBLESHOOTING

### "Still missing small invoices"
- Check execution log for "Filename has keyword" messages
- Verify invoice filenames contain keywords from CONFIG.invoiceKeywords
- If not, add more specific keywords

### "Saving unwanted files"
- Check control folder for patterns
- Add those patterns to CONFIG.skipWords
- Examples: your company name, vendor-specific codes

### "Control folder has legitimate invoices"
- Check which skip-word triggered rejection
- Remove or refine that skip-word
- OR add more invoice keywords

---

## üéØ KEY IMPROVEMENTS IN v1.6

### **1. Filename Keyword Checking**
```javascript
// v1.5: Checked size FIRST (wrong!)
if (fileSize < 50000) skip;

// v1.6: Check filename FIRST (correct!)
if (filename has invoice keyword) save_regardless_of_size;
```

### **2. Skip-Words List**
Explicit list of words that indicate non-invoice files:
- header, icon, badge, logo, signature, footer, etc.

### **3. Control Folder**
All skipped files saved for review and analysis:
- Helps refine filtering rules
- Identifies false positives
- Provides audit trail

### **4. Better Logging**
```
OLD: ‚äò Skipped small file (19KB): N√∂mina 08_2025.pdf
NEW: ‚úì Filename has keyword, saving regardless of size: N√∂mina 08_2025.pdf (19KB)
```

---

## üí∞ SYSTEM COSTS (Unchanged)

- **FREE:** Apps Script, Gmail API, Drive API, Sheets API
- **PAID:** Vision API ($0-3/month for most businesses)
- **Total:** $0-3/month

---

## ‚úÖ PRODUCTION READINESS

**v1.6 Status:** ‚úÖ STABLE & PRODUCTION READY

**Fixed Issues:**
- ‚úÖ Small invoices with keywords now saved
- ‚úÖ Icons/logos filtered by skip-words
- ‚úÖ Control folder for analysis
- ‚úÖ Better logging

**Known Limitations:**
- If invoice filename has NO keywords and is < 50KB, it will be skipped
- Solution: Add more specific keywords to CONFIG.invoiceKeywords

---

**Deploy v1.6 and check the control folder to refine filtering!**

---

*Last updated: 2025-01-19*
*This is the RECOMMENDED production version*
